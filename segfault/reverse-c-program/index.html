<!DOCTYPE html>
<html lang="en-US" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Reversing a C program &middot; </title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://cybersec.upvision.co/favicon.ico" />
    <link rel="canonical" href="https://cybersec.upvision.co/segfault/reverse-c-program/" />
    <link href="https://fonts.googleapis.com/css?family=Orbitron|Fira+Mono|Roboto|Fira+Mono" rel="stylesheet">
     <meta name="description" content="Given a binary, the program is reversed into a C program to understand what it does." /> 

    

    <meta name="generator" content="Hugo 0.42.1" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="https://cybersec.upvision.co/built/screen.css" /> 
    <link rel="stylesheet" type="text/css" href="https://cybersec.upvision.co/css/casper-two.css" /> 
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    <style>
		@font-face {
		    font-family: Mplus Reg;
		    src: url("https://cybersec.upvision.co/fonts/mplus-1mn-regular.ttf");
		}
	</style>
    

     

</head>


<body class="post-template">
  <div class="site-wrapper"> 

<header class="site-header outer">
  <div class="inner">
    <nav class="site-nav">
      <div class="site-nav-left">

        <ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/about/"
              	style="font-size:18px;"
              >
          			About
          	  </a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/segfault/"
              	style="font-size:18px;"
              >
          			Segfault
          	  </a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/post/"
              	style="font-size:18px;"
              >
          			Blog
          	  </a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
			<a class="social-link" href="https://github.com/CyberSecNITD" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
			<a class="social-link" href="https://t.me/joinchat/Ez80i0_cdc8cQv5IUceBzg" target="_blank" rel="noopener"><svg width="24px" height="24px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;" viewBox="0 0 24 24"><path id="telegram-4" d="M12,0c-6.626,0 -12,5.372 -12,12c0,6.627 5.374,12 12,12c6.627,0 12,-5.373 12,-12c0,-6.628 -5.373,-12 -12,-12Zm3.224,17.871c0.188,0.133 0.43,0.166 0.646,0.085c0.215,-0.082 0.374,-0.267 0.422,-0.491c0.507,-2.382 1.737,-8.412 2.198,-10.578c0.035,-0.164 -0.023,-0.334 -0.151,-0.443c-0.129,-0.109 -0.307,-0.14 -0.465,-0.082c-2.446,0.906 -9.979,3.732 -13.058,4.871c-0.195,0.073 -0.322,0.26 -0.316,0.467c0.007,0.206 0.146,0.385 0.346,0.445c1.381,0.413 3.193,0.988 3.193,0.988c0,0 0.847,2.558 1.288,3.858c0.056,0.164 0.184,0.292 0.352,0.336c0.169,0.044 0.348,-0.002 0.474,-0.121c0.709,-0.669 1.805,-1.704 1.805,-1.704c0,0 2.084,1.527 3.266,2.369Zm-6.423,-5.062l0.98,3.231l0.218,-2.046c0,0 3.783,-3.413 5.941,-5.358c0.063,-0.057 0.071,-0.153 0.019,-0.22c-0.052,-0.067 -0.148,-0.083 -0.219,-0.037c-2.5,1.596 -6.939,4.43 -6.939,4.43Z"/></svg></a>

	
        </div>  
            
      </div>

    </nav>  

  </div>
</header>


<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
      <article class="post-full post"> 
    <header class="post-full-header">
        <style>
        	time,span{
        		color:black !important;
        	}

    	</style>
        <section class="post-full-meta" >
            <time class="post-full-meta-date" datetime="2020-02-11">11 February 2020
            </time>
            <span class="date-divider">/</span>
             
            <a href="https://cybersec.upvision.co/tags/segfault/" 
            	style="text-decoration: underline;color:black;" 
            	>
            	#segfault
            </a>&nbsp;
        </section>
        <h1 class="post-full-title" style="font-family: 'Fira Mono', monospace;">Reversing a C program</h1>
    </header>
    
    <figure class="post-full-image" style="background-image: url(https://cybersec.upvision.co/images/0x01_segfault_banner.png)">
    </figure>

    <section class="post-full-content">
        <div class="kg-card-markdown" style="font-family: 'Fira Mono', monospace;">
        

<h1 id="reversing-a-c-program">Reversing a C Program</h1>

<p>It&rsquo;s said C is low level programming language, well that&rsquo;s not true. It became that way because of advancements in new programming languages such
as Python, Java, Javascript, Ruby. These run on a VM, thereby incur a heavy abstraction cost.</p>

<p>Now C programs are compiled to assembly, since C have not much syntax sugar it become easy to read the Assembly and figure out the possible C code to it.</p>

<p>Given is a C program, compiled to a binary and then disassembled to reverse engineer.</p>

<pre><code class="language-asm">(gdb) disass main
	Dump of assembler code for function main:
	   0x000005cd &lt;+0&gt;:     lea    ecx,[esp+0x4]
	   0x000005d1 &lt;+4&gt;:     and    esp,0xfffffff0
	   0x000005d4 &lt;+7&gt;:     push   DWORD PTR [ecx-0x4]
	   0x000005d7 &lt;+10&gt;:    push   ebp
	   0x000005d8 &lt;+11&gt;:    mov    ebp,esp
	   0x000005da &lt;+13&gt;:    push   ebx
	   0x000005db &lt;+14&gt;:    push   ecx
	   0x000005dc &lt;+15&gt;:    sub    esp,0x20
	   0x000005df &lt;+18&gt;:    call   0x4d0 &lt;__x86.get_pc_thunk.bx&gt;
	   0x000005e4 &lt;+23&gt;:    add    ebx,0x19ec
	   0x000005ea &lt;+29&gt;:    mov    eax,gs:0x14
	   0x000005f0 &lt;+35&gt;:    mov    DWORD PTR [ebp-0xc],eax
	   0x000005f3 &lt;+38&gt;:    xor    eax,eax
	   0x000005f5 &lt;+40&gt;:    mov    DWORD PTR [ebp-0x1c],0x0
	   0x000005fc &lt;+47&gt;:    mov    DWORD PTR [ebp-0x14],0x0
	   0x00000603 &lt;+54&gt;:    sub    esp,0xc
	   0x00000606 &lt;+57&gt;:    lea    eax,[ebx-0x1870]
	   0x0000060c &lt;+63&gt;:    push   eax
	   0x0000060d &lt;+64&gt;:    call   0x440 &lt;printf@plt&gt;
	   0x00000612 &lt;+69&gt;:    add    esp,0x10
	   0x00000615 &lt;+72&gt;:    sub    esp,0x8
	   0x00000618 &lt;+75&gt;:    lea    eax,[ebp-0x1c]
	   0x0000061b &lt;+78&gt;:    push   eax
	   0x0000061c &lt;+79&gt;:    lea    eax,[ebx-0x185e]
	   0x00000622 &lt;+85&gt;:    push   eax
	   0x00000623 &lt;+86&gt;:    call   0x470 &lt;__isoc99_scanf@plt&gt;
	   0x00000628 &lt;+91&gt;:    add    esp,0x10
	   0x0000062b &lt;+94&gt;:    mov    DWORD PTR [ebp-0x10],0x1
	   0x00000632 &lt;+101&gt;:   jmp    0x669 &lt;main+156&gt;
	   0x00000634 &lt;+103&gt;:   sub    esp,0x8
	   0x00000637 &lt;+106&gt;:   push   DWORD PTR [ebp-0x10]
	   0x0000063a &lt;+109&gt;:   lea    eax,[ebx-0x185b]
	   0x00000640 &lt;+115&gt;:   push   eax
	   0x00000641 &lt;+116&gt;:   call   0x440 &lt;printf@plt&gt;
	   0x00000646 &lt;+121&gt;:   add    esp,0x10
	   0x00000649 &lt;+124&gt;:   sub    esp,0x8
	   0x0000064c &lt;+127&gt;:   lea    eax,[ebp-0x18]
	   0x0000064f &lt;+130&gt;:   push   eax
	   0x00000650 &lt;+131&gt;:   lea    eax,[ebx-0x185e]
	   0x00000656 &lt;+137&gt;:   push   eax
	   0x00000657 &lt;+138&gt;:   call   0x470 &lt;__isoc99_scanf@plt&gt;
	   0x0000065c &lt;+143&gt;:   add    esp,0x10
	   0x0000065f &lt;+146&gt;:   mov    eax,DWORD PTR [ebp-0x18]
	   0x00000662 &lt;+149&gt;:   add    DWORD PTR [ebp-0x14],eax
	   0x00000665 &lt;+152&gt;:   add    DWORD PTR [ebp-0x10],0x1
	   0x00000669 &lt;+156&gt;:   mov    eax,DWORD PTR [ebp-0x1c]
	   0x0000066c &lt;+159&gt;:   cmp    DWORD PTR [ebp-0x10],eax
	   0x0000066f &lt;+162&gt;:   jle    0x634 &lt;main+103&gt;
	   0x00000671 &lt;+164&gt;:   mov    ecx,DWORD PTR [ebp-0x1c]
	   0x00000674 &lt;+167&gt;:   mov    eax,DWORD PTR [ebp-0x14]
	   0x00000677 &lt;+170&gt;:   cdq
	   0x00000678 &lt;+171&gt;:   idiv   ecx
	   0x0000067a &lt;+173&gt;:   mov    edx,eax
	   0x0000067c &lt;+175&gt;:   mov    eax,DWORD PTR [ebp-0x1c]
	   0x0000067f &lt;+178&gt;:   sub    esp,0x4
	   0x00000682 &lt;+181&gt;:   push   edx
	   0x00000683 &lt;+182&gt;:   push   eax
	   0x00000684 &lt;+183&gt;:   lea    eax,[ebx-0x1844]
	   0x0000068a &lt;+189&gt;:   push   eax
	   0x0000068b &lt;+190&gt;:   call   0x440 &lt;printf@plt&gt;
	   0x00000690 &lt;+195&gt;:   add    esp,0x10
	   0x00000693 &lt;+198&gt;:   mov    eax,0x0
	   0x00000698 &lt;+203&gt;:   mov    ecx,DWORD PTR [ebp-0xc]
	   0x0000069b &lt;+206&gt;:   xor    ecx,DWORD PTR gs:0x14
	   0x000006a2 &lt;+213&gt;:   je     0x6a9 &lt;main+220&gt;
	   0x000006a4 &lt;+215&gt;:   call   0x730 &lt;__stack_chk_fail_local&gt;
	   0x000006a9 &lt;+220&gt;:   lea    esp,[ebp-0x8]
	   0x000006ac &lt;+223&gt;:   pop    ecx
	   0x000006ad &lt;+224&gt;:   pop    ebx
	   0x000006ae &lt;+225&gt;:   pop    ebp
	   0x000006af &lt;+226&gt;:   lea    esp,[ecx-0x4]
	   0x000006b2 &lt;+229&gt;:   ret
	End of assembler dump.
</code></pre>

<p>When it comes to reverse engineering, it boils down to a process of induction. We are evident of <code>functions</code> in C, we add them using header files and then call them to our need.
Then we use a lot of variables, for computation, passing it to functions. Then some conditionals and iterators(loops), well loops are basically conditional branching repeatedly executes a piece of code.</p>

<p>It is important to understand the assembly code, refer to this <a href="https://www.cs.virginia.edu/~evans/cs216/guides/x86.html">x86 assembly guide</a>.</p>

<p>And lastly, it about developing a approach to tackling a problem, in this case you might find it definitive to follow the instructions given but it might break when the program becomes complex. Then you must evaluate and develop new techniques, many security researchers write their experiences on finding bugs, read them and introspect on their techniques.</p>

<h1 id="approach">Approach?</h1>

<p>Here is the plan. Given the disassembly, we will be</p>

<ol>
<li>Finding all the function calls</li>
<li>Find the variables used.</li>
<li>Find the conditionals and detect loops</li>
<li>Branch the code into chunks for easy understanding</li>
<li>Convert group of instructions to possible C code.</li>
<li>Lay it out and understand what it does.</li>
</ol>

<h2 id="step-1-finding-all-the-function-calls">Step 1: Finding all the function calls</h2>

<ul>
<li>Look out for <code>call</code> instructions, all the <code>push</code> instructions above it would be the arguments passed.</li>
</ul>

<p><img src="/images/paper_disass_fncall.png" alt="function calls" /></p>

<h2 id="step-2-find-the-variables-used">Step 2: Find the variables used.</h2>

<ul>
<li>Variables are stored on the stack</li>
<li>Find references to the stack in the form <code>[ebp - 0x10]</code>, these are usage of variables.</li>
<li>It seems like they are 32bit variables, possibly being <code>int</code></li>
</ul>

<p><img src="/images/paper_disass_find_stack.svg" alt="variables on the stack" /></p>

<h2 id="step-3-find-the-conditionals-and-detect-loops">Step 3: Find the conditionals and detect loops</h2>

<ul>
<li>Look out for jump statements

<ul>
<li><code>jmp</code> is an unconditional jump</li>
<li><code>jle</code> is a conditional jump, it checks the result of <code>cmp</code> and decides to jump accordingly.</li>
</ul></li>
<li>From the drawn lines, it is evident it is a loop, what kind of a loop would it be? <code>while</code> or <code>for</code>?</li>
</ul>

<p><img src="/images/paper_disass_jumps.svg" alt="jumps" /></p>

<h2 id="step-4-branch-the-code-into-chunks">Step 4: Branch the code into chunks</h2>

<ul>
<li>Here is the plan, divide the code based on jumps.

<ul>
<li><code>prologue</code> is related to setting up stack for the <code>main</code>, not related.</li>
<li><code>S1</code> code until our first <code>jmp</code></li>
<li><code>S2</code> after we jump from <code>S1</code>, it has a <code>jle</code> which branches to 2 other blocks</li>
<li><code>S3</code> when condition on <code>S2</code> is true, note that it also has code which is repeated.</li>
<li>The next instruction after <code>S3</code> is in <code>S2</code></li>
<li>When the condition in <code>S2</code> fails, it jumps to <code>epilogue</code> which is the last part.</li>
</ul></li>
</ul>

<p><img src="/images/paper_disass_blocks.svg" alt="code blocks" /></p>

<h2 id="step-5-convert-group-of-instructions-to-possible-c-code">Step 5: Convert group of instructions to possible C code.</h2>

<p>This is interesting because I want you to think in C. Consider this as game, I tell you some facts, you tell me the corresponding C code.</p>

<p>Let&rsquo;s play!</p>

<ol>
<li><p>Takes a constant and puts it in a variable?</p>

<p><code>a = 0</code></p></li>

<li><p>Takes arguments and then calls a function.</p>

<p><code>printf(&quot;hello, world&quot;);</code></p></li>

<li><p>Increments a variable by a certain amount</p>

<p><code>a += b</code> or <code>a += 1</code></p></li>

<li><p>Divides a nummber with another and stores it at the same place. basically dividing itself.</p>

<p><code>a =/ b</code></p></li>
</ol>

<p><img src="/images/paper_disass_decompile.svg" alt="decompiled" /></p>

<h2 id="step-6-lay-it-out-and-understand-what-it-does">Step 6: Lay it out and understand what it does.</h2>

<p>Now we have the C code, it should be easy to understand what it does.</p>

<script src="//gist.github.com/Boot-Error/94eaeea171fdd31e019efce976592a0f.js"></script>

<p>We can dry run this code to fathom its flow and derieve the algorithm used.</p>

<h3 id="observations">Observations</h3>

<ul>
<li><code>local_1c</code> and <code>local_14</code> are initialized to 0</li>
<li><code>local_1c</code> is taken by user input, let&rsquo;s say 3 (<code>local_1c = 3</code>)</li>
<li><code>local_10</code> is compared with <code>local_1c</code> in the <code>while</code> loop.

<ul>
<li><code>local_18</code> is taken by user input, let&rsquo;s&rsquo; say 2 (<code>local_18 = 2</code>)</li>
<li><code>local_14</code> is incremented by <code>local_18</code>, i.e (<code>local_14 = 0 + 2</code>)</li>
<li><code>local_10</code> is incremented by 1, (<code>local_10 = 1</code>)</li>
</ul></li>
<li>The loop is broken when <code>local_10 = 4</code></li>
<li><code>local_14</code> is divded by <code>local_1c</code> which was taken at the beginning, which infact is no of times the while loop ran.</li>
<li>The values in <code>local_14</code> and <code>local_1c</code> is displayed</li>
</ul>

<p>To conclude, its doing sum of numbers and dividing by no of times the loop ran, hence its computing <strong>average of numbers</strong>.</p>
    
        </div>
    </section>

    <footer class="post-full-footer">
      <section class="author-card">
        <img class="author-profile-image" src="https://avatars2.githubusercontent.com/u/8546140?s=400&amp;v=4" alt="Author" />
        <section class="author-card-content">
            <h4 class="author-card-name"><a href="http://github.com/Boot-Error">Vighnesh</a></h4>
                <p></p>
        </section>
      </section>
    </footer>
</article>
    
    
    

  </div>
</main>


<aside class="read-next outer">
  <div class="inner">
    <div class="read-next-feed">      
      
<article class="read-next-card" style="background-color: #090a0b;">
    <header class="read-next-card-header">
        <small class="read-next-card-header-sitetitle">&mdash; CyberSec NITD &mdash;</small>
        
        <h3 class="read-next-card-header-title"><a href="https://cybersec.upvision.co/tags/segfault/">#segfault</a></h3>
    </header>
    <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
    </div>

    <div class="read-next-card-content">
      
        <ul>
          <li><a href="https://cybersec.upvision.co/events/segfault/">Segfault - Reverse Engineering Workshop series</a></li>            
        
          <li><a href="https://cybersec.upvision.co/segfault/0x01/">0x01 - segfault</a></li>            
        
          <li><a href="https://cybersec.upvision.co/events/rootctf18/">Root CTF 2018</a></li>            
        
          <li><a href="https://cybersec.upvision.co/events/feb19ieeemeetup/">CyberSecNITD meetup with IEEE NITD student branch</a></li>            
        </ul>
    </div>
    <footer class="read-next-card-footer">
      
        <a href="https://cybersec.upvision.co/tags/segfault/">See all related posts â†’</a>
    </footer>
</article>


      
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://cybersec.upvision.co/segfault/0x01/">
      <div class="post-card-image" style="background-image: url(https://cybersec.upvision.co/images/0x01_segfault_banner.png)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://cybersec.upvision.co/segfault/0x01/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #segfault 
              #workshop  </span>
              
              <h2 class="post-card-title">0x01 - segfault</h2>
          </header>
          <section class="post-card-excerpt">
               
                <p>Binary Analysis - Reversing C Programs</p>
              
          </section>
      </a>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://avatars2.githubusercontent.com/u/8546140?s=400&amp;v=4" alt="Author" />
          <span class="post-card-author"><a href="/">Vighnesh</a></span>
      </footer>
    </div>
</article>
      
      
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://cybersec.upvision.co/segfault/0x00/">
      <div class="post-card-image" style="background-image: url(https://cybersec.upvision.co/images/0x00_segfault_banner.png)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://cybersec.upvision.co/segfault/0x00/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #segfault 
              #workshop  </span>
              
              <h2 class="post-card-title">0x00 - Segfault</h2>
          </header>
          <section class="post-card-excerpt">
               
                <p>First workshop on wtf is Reverse Engineering?</p>
              
          </section>
      </a>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://avatars2.githubusercontent.com/u/8546140?s=400&amp;v=4" alt="Author" />
          <span class="post-card-author"><a href="/">Vighnesh</a></span>
      </footer>
    </div>
</article>
      
    </div>
  </div>
</aside>

<div class="floating-header">
  <style type="text/css"> 
		.progress::-webkit-progress-value{
		    background-color:black !important;
		}
		.progress::-moz-progress-bar{
		    background-color:black !important;
		}
		.floating-header{
			height:initial !important; 
		}
		.progress, .progress-container{
			height:4px !important;
		}
		.progress{
			bottom:-4px !important;
		}
	</style>
  <progress class="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar" style="background-color:black"></span>
    </div>
  </progress>
</div>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/">CyberSec NITD</a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
    </nav>  
  </div>
</footer>

</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://cybersec.upvision.co/js/jquery.fitvids.js"></script>

<script>hljs.initHighlightingOnLoad();</script>



    <script>





$(document).ready(function () {
    
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
</body></html>
